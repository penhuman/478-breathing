<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4-7-8 呼吸放鬆引導 (AI 增強版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&display=swap');

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #1a1c2c 0%, #4a192c 100%);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .breath-circle {
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.1), inset 0 0 20px rgba(255, 255, 255, 0.1);
            transition-property: transform, background-color, box-shadow;
            will-change: transform;
        }

        .inhale-state {
            box-shadow: 0 0 40px rgba(100, 200, 255, 0.6), inset 0 0 30px rgba(100, 200, 255, 0.4);
            background-color: rgba(56, 189, 248, 0.3);
        }

        .hold-state {
            box-shadow: 0 0 50px rgba(255, 255, 255, 0.8), inset 0 0 40px rgba(255, 255, 255, 0.5);
            background-color: rgba(255, 255, 255, 0.2);
        }

        .exhale-state {
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.1), inset 0 0 10px rgba(255, 255, 255, 0.1);
            background-color: rgba(30, 41, 59, 0.5);
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Loading Spinner Animation */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #fff;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="h-screen w-full flex flex-col items-center justify-center overflow-hidden text-white selection:bg-pink-500 selection:text-white">

    <!-- 主容器 -->
    <div class="relative w-full max-w-md mx-auto p-4 flex flex-col items-center h-full justify-center">
        
        <!-- 標題區域 -->
        <div class="text-center mb-6 z-10 shrink-0">
            <h1 class="text-2xl sm:text-3xl font-light tracking-widest text-white/90 mb-1">4-7-8 呼吸法</h1>
            <p class="text-xs sm:text-sm text-white/60 font-light">放鬆神經系統，減輕焦慮</p>
        </div>

        <!-- 呼吸動畫區域 -->
        <div class="relative w-64 h-64 sm:w-72 sm:h-72 flex items-center justify-center mb-8 shrink-0">
            <!-- 外圈軌道 -->
            <div class="absolute w-full h-full rounded-full border border-white/10 scale-100"></div>
            <div class="absolute w-[80%] h-[80%] rounded-full border border-white/5 scale-100"></div>

            <!-- 核心呼吸圓圈 -->
            <div id="breathCircle" class="breath-circle w-full h-full rounded-full bg-slate-800/50 backdrop-blur-sm absolute transform scale-30 exhale-state"></div>

            <!-- 中心文字與計時 -->
            <div class="relative z-10 flex flex-col items-center justify-center text-center pointer-events-none">
                <div id="instructionText" class="text-3xl sm:text-4xl font-bold tracking-wider drop-shadow-lg mb-2 transition-all duration-500">準備</div>
                <div id="timerDisplay" class="text-xl sm:text-2xl font-light text-white/80 font-mono">0</div>
            </div>
        </div>

        <!-- AI 引導顯示區 (預設隱藏，生成後顯示) -->
        <div id="aiGuidanceDisplay" class="hidden w-full mb-6 z-10 text-center animate-fade-in px-4">
            <div class="glass-panel rounded-xl p-4 text-sm sm:text-base text-white/90 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-1 h-full bg-gradient-to-b from-purple-400 to-pink-400"></div>
                <p id="aiText" class="italic leading-relaxed">"..."</p>
            </div>
        </div>

        <!-- 控制按鈕 -->
        <div class="z-10 flex gap-4 shrink-0 mb-6">
            <button id="startBtn" onclick="toggleBreathing()" class="glass-panel hover:bg-white/20 text-white font-medium py-3 px-8 rounded-full transition-all duration-300 transform active:scale-95 shadow-lg flex items-center gap-2 group">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="group-hover:text-green-400 transition-colors"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                <span id="btnText">開始練習</span>
            </button>
            
            <button id="resetBtn" onclick="resetExercise()" class="hidden glass-panel hover:bg-white/20 text-white/80 hover:text-red-300 py-3 px-4 rounded-full transition-all duration-300 shadow-lg" title="重置">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74-2.74L3 12"></path></svg>
            </button>
        </div>

        <!-- AI 功能觸發區 -->
        <div class="w-full max-w-sm z-20 shrink-0">
            <div id="aiInputSection" class="glass-panel rounded-2xl p-1 transition-all duration-300 overflow-hidden">
                <button onclick="toggleAIInput()" class="w-full flex items-center justify-between p-3 text-white/80 hover:text-white transition-colors">
                    <span class="flex items-center gap-2 text-sm font-medium">
                        <span class="text-yellow-300 text-lg">✨</span> AI 心靈調頻
                    </span>
                    <svg id="chevronIcon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="transition-transform"><polyline points="6 9 12 15 18 9"></polyline></svg>
                </button>
                
                <div id="aiInputContent" class="hidden px-3 pb-3 pt-1 border-t border-white/10">
                    <p class="text-xs text-white/60 mb-2">告訴 AI 您現在的感受，獲得專屬引導：</p>
                    <div class="flex gap-2">
                        <input type="text" id="moodInput" placeholder="例：我很焦慮、工作壓力大..." class="flex-1 bg-white/10 border border-white/10 rounded-lg px-3 py-2 text-sm text-white placeholder-white/30 focus:outline-none focus:bg-white/20 focus:border-white/30 transition-all">
                        <button onclick="generateGuidance()" id="generateBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white rounded-lg px-4 py-2 text-sm font-medium transition-colors flex items-center justify-center min-w-[60px]">
                            <span id="genBtnText">生成</span>
                            <div id="genBtnSpinner" class="spinner hidden"></div>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 狀態指示條 -->
        <div class="mt-6 flex gap-2 shrink-0">
            <div id="dot1" class="w-2 h-2 rounded-full bg-white/20 transition-colors duration-500"></div>
            <div id="dot2" class="w-2 h-2 rounded-full bg-white/20 transition-colors duration-500"></div>
            <div id="dot3" class="w-2 h-2 rounded-full bg-white/20 transition-colors duration-500"></div>
        </div>
    </div>

    <script>
        const circle = document.getElementById('breathCircle');
        const instructionText = document.getElementById('instructionText');
        const timerDisplay = document.getElementById('timerDisplay');
        const startBtn = document.getElementById('startBtn');
        const btnText = document.getElementById('btnText');
        const resetBtn = document.getElementById('resetBtn');
        const dots = [document.getElementById('dot1'), document.getElementById('dot2'), document.getElementById('dot3')];
        
        // AI 相關元件
        const aiInputContent = document.getElementById('aiInputContent');
        const chevronIcon = document.getElementById('chevronIcon');
        const moodInput = document.getElementById('moodInput');
        const generateBtn = document.getElementById('generateBtn');
        const genBtnText = document.getElementById('genBtnText');
        const genBtnSpinner = document.getElementById('genBtnSpinner');
        const aiGuidanceDisplay = document.getElementById('aiGuidanceDisplay');
        const aiText = document.getElementById('aiText');

        let isRunning = false;
        let controller = new AbortController();

        // --- Gemini API 整合 ---
        const apiKey = ""; // API Key 會由系統執行環境自動注入

        async function generateGuidance() {
            const mood = moodInput.value.trim();
            if (!mood) return;

            // UI Loading 狀態
            setLoading(true);

            try {
                const prompt = `
                    使用者即將進行 4-7-8 呼吸練習。
                    使用者目前的心情或狀態是：「${mood}」。
                    
                    請用繁體中文，扮演一位溫柔的正念導師。
                    生成一段簡短的「正念引導語」（不超過 30 個字）。
                    內容要能安撫這個特定的情緒，並引導他們將專注力放在呼吸上。
                    語氣要非常溫柔、安定。直接給出引導語即可，不要有其他前言後語。
                `;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message);
                }

                const guidanceText = data.candidates[0].content.parts[0].text.trim();
                
                // 顯示結果
                aiText.innerText = guidanceText;
                aiGuidanceDisplay.classList.remove('hidden');
                
                // 收起輸入框，讓介面乾淨
                toggleAIInput(false);

            } catch (error) {
                console.error("Gemini API Error:", error);
                alert("無法生成引導，請稍後再試。");
            } finally {
                setLoading(false);
            }
        }

        function setLoading(isLoading) {
            if (isLoading) {
                genBtnText.classList.add('hidden');
                genBtnSpinner.classList.remove('hidden');
                generateBtn.disabled = true;
                generateBtn.classList.add('opacity-70', 'cursor-not-allowed');
            } else {
                genBtnText.classList.remove('hidden');
                genBtnSpinner.classList.add('hidden');
                generateBtn.disabled = false;
                generateBtn.classList.remove('opacity-70', 'cursor-not-allowed');
            }
        }

        function toggleAIInput(forceState) {
            const content = aiInputContent;
            const icon = chevronIcon;
            
            const isHidden = content.classList.contains('hidden');
            const shouldShow = forceState !== undefined ? forceState : isHidden;

            if (shouldShow) {
                content.classList.remove('hidden');
                icon.style.transform = 'rotate(180deg)';
                setTimeout(() => moodInput.focus(), 100);
            } else {
                content.classList.add('hidden');
                icon.style.transform = 'rotate(0deg)';
            }
        }

        // --- 呼吸邏輯 (保持原有邏輯) ---

        const wait = (ms, signal) => {
            return new Promise((resolve, reject) => {
                const timeout = setTimeout(() => resolve(), ms);
                if (signal) {
                    signal.addEventListener('abort', () => {
                        clearTimeout(timeout);
                        reject(new DOMException('Aborted', 'AbortError'));
                    });
                }
            });
        };

        function updateUI(text, scale, durationCSS, className, activeDotIndex) {
            instructionText.innerText = text;
            circle.style.transition = `transform ${durationCSS}s linear, background-color 2s ease, box-shadow 2s ease`;
            circle.style.transform = `scale(${scale})`;
            
            circle.classList.remove('inhale-state', 'hold-state', 'exhale-state');
            if(className) circle.classList.add(className);

            dots.forEach((dot, index) => {
                dot.style.backgroundColor = index === activeDotIndex ? 'rgba(255,255,255,0.9)' : 'rgba(255,255,255,0.2)';
            });
        }

        async function runCountdown(seconds, signal) {
            for (let i = 1; i <= seconds; i++) {
                timerDisplay.innerText = i; 
                await wait(1000, signal);
            }
        }

        async function breathingLoop() {
            try {
                const signal = controller.signal;

                while (isRunning) {
                    updateUI("吸氣", 1.0, 4, 'inhale-state', 0);
                    await runCountdown(4, signal);

                    updateUI("憋氣", 1.0, 0, 'hold-state', 1);
                    circle.style.transition = "transform 7s ease-in-out";
                    circle.style.transform = "scale(0.95)"; 
                    await runCountdown(7, signal);

                    updateUI("吐氣", 0.3, 8, 'exhale-state', 2);
                    await runCountdown(8, signal);
                }
            } catch (error) {
                if (error.name !== 'AbortError') console.error(error);
            }
        }

        function toggleBreathing() {
            if (isRunning) {
                resetExercise();
            } else {
                startExercise();
            }
        }

        function startExercise() {
            isRunning = true;
            controller = new AbortController();
            
            startBtn.classList.add('bg-white/10');
            startBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-400"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>
                <span>停止</span>
            `;
            resetBtn.classList.remove('hidden');
            
            // 如果 AI 區塊是打開的，開始練習時自動收起，避免干擾
            toggleAIInput(false);

            breathingLoop();
        }

        function resetExercise() {
            isRunning = false;
            controller.abort();

            circle.style.transition = "transform 0.5s ease-out";
            circle.style.transform = "scale(0.3)";
            circle.classList.remove('inhale-state', 'hold-state', 'exhale-state');
            circle.classList.add('exhale-state');
            
            instructionText.innerText = "準備";
            timerDisplay.innerText = "0";
            
            startBtn.classList.remove('bg-white/10');
            startBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="group-hover:text-green-400 transition-colors"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                <span id="btnText">開始練習</span>
            `;
            resetBtn.classList.add('hidden');

            dots.forEach(dot => dot.style.backgroundColor = 'rgba(255,255,255,0.2)');
        }
    </script>
</body>
</html>
